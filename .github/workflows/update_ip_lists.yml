name: Update IP Lists

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  update-lists:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create directory
        run: mkdir -p Country_CIDR

      - name: Download, process lists, and generate README
        run: |
          declare -A url_map
          url_map["https://ispip.clang.cn/chinatelecom.txt"]="CN_CT.conf"
          url_map["https://ispip.clang.cn/unicom_cnc.txt"]="CN_CU.conf"
          url_map["https://ispip.clang.cn/cmcc.txt"]="CN_CM.conf"
          url_map["https://ispip.clang.cn/chinabtn.txt"]="CN_BTN.conf"
          url_map["https://ispip.clang.cn/cernet.txt"]="CN_CERNET.conf"
          url_map["https://ispip.clang.cn/gwbn.txt"]="CN_GWBN.conf"
          url_map["https://ispip.clang.cn/othernet.txt"]="CN_Other.conf"
          url_map["https://ispip.clang.cn/chinatelecom_ipv6.txt"]="CN_CT_IPv6.conf"
          url_map["https://ispip.clang.cn/unicom_cnc_ipv6.txt"]="CN_CU_IPv6.conf"
          url_map["https://ispip.clang.cn/cmcc_ipv6.txt"]="CN_CM_IPv6.conf"
          url_map["https://ispip.clang.cn/chinabtn_ipv6.txt"]="CN_BTN_IPv6.conf"
          url_map["https://ispip.clang.cn/cernet_ipv6.txt"]="CN_CERNET_IPv6.conf"
          url_map["https://ispip.clang.cn/gwbn_ipv6.txt"]="CN_GWBN_IPv6.conf"
          url_map["https://ispip.clang.cn/othernet_ipv6.txt"]="CN_Other_IPv6.conf"
          url_map["https://raw.githubusercontent.com/bgptools/anycast-prefixes/refs/heads/master/anycatch-v4-prefixes.txt"]="Anycast.conf"
          url_map["https://raw.githubusercontent.com/bgptools/anycast-prefixes/refs/heads/master/anycatch-v6-prefixes.txt"]="Anycast_IPv6.conf"

          total_cidrs=0
          successful_files=0
          declare -A file_stats

          for url in "${!url_map[@]}"; do
            output_filename=${url_map[$url]}
            content=$(curl -s "$url")
            if [ -n "$content" ]; then
              processed_content=$(echo "$content" | sed 's/^/route /;s/$/ via "lo";/')
              echo "$processed_content" > "Country_CIDR/$output_filename"
              line_count=$(echo "$processed_content" | wc -l)
              file_stats["$output_filename"]=$line_count
              total_cidrs=$((total_cidrs + line_count))
              successful_files=$((successful_files + 1))
            fi
          done

          declare -A operator_map
          operator_map["CN_BTN.conf"]="ä¸­å›½å¹¿ç”µ"
          operator_map["CN_BTN_IPv6.conf"]="ä¸­å›½å¹¿ç”µ"
          operator_map["CN_CERNET.conf"]="ä¸­å›½æ•™è‚²ç½‘"
          operator_map["CN_CERNET_IPv6.conf"]="ä¸­å›½æ•™è‚²ç½‘"
          operator_map["CN_CM.conf"]="ä¸­å›½ç§»åŠ¨"
          operator_map["CN_CM_IPv6.conf"]="ä¸­å›½ç§»åŠ¨"
          operator_map["CN_CT.conf"]="ä¸­å›½ç”µä¿¡"
          operator_map["CN_CT_IPv6.conf"]="ä¸­å›½ç”µä¿¡"
          operator_map["CN_CU.conf"]="ä¸­å›½è”é€š"
          operator_map["CN_CU_IPv6.conf"]="ä¸­å›½è”é€š"
          operator_map["CN_GWBN.conf"]="ç”µä¿¡é€š/é•¿åŸŽå®½å¸¦/é¹åšå£«"
          operator_map["CN_GWBN_IPv6.conf"]="ç”µä¿¡é€š/é•¿åŸŽå®½å¸¦/é¹åšå£«"
          operator_map["CN_Other.conf"]="ä¸­å›½å…¶ä»–ISP"
          operator_map["CN_Other_IPv6.conf"]="ä¸­å›½å…¶ä»–ISP"
          operator_map["Anycast.conf"]="Anycast"
          operator_map["Anycast_IPv6.conf"]="Anycast"

          TIMESTAMP=$(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M:%S")
          
          {
            echo "# ä¸­å›½å¤§é™†IPåœ°å€è·¯ç”±è¡¨"
            echo ""
            echo "**æ³¨æ„ï¼š** æœ¬é¡¹ç›®ä¸­çš„IPåˆ—è¡¨çš†ä»Ž **[è‹ç‹¼å±±åº„](https://ispip.clang.cn/)** / **[bgptools/anycast-prefixes](https://github.com/bgptools/anycast-prefixes)** èŽ·å–ï¼Œä»…ä¾›å­¦ä¹ å’Œæµ‹è¯•ä½¿ç”¨ã€‚"
            echo ""
            echo "---"
            echo ""
            echo "## ðŸ“Š æœ€æ–°ç»Ÿè®¡ä¿¡æ¯"
            echo ""
            echo "**æœ€åŽæ›´æ–°æ—¶é—´:** $TIMESTAMP"
            echo ""
            echo "### ðŸ“ˆ æ€»ä½“ç»Ÿè®¡"
            echo "- **æ€»CIDRè®°å½•æ•°:** $total_cidrs"
            echo "- **æˆåŠŸæ›´æ–°æ–‡ä»¶æ•°:** $successful_files / ${#url_map[@]}"
            echo ""
            echo "### ðŸ“ æ–‡ä»¶åˆ—è¡¨åŠCIDRæ•°é‡"
            echo ""
            echo "| æ–‡ä»¶å | è¿è¥å•† | CIDR æ•°é‡ |"
            echo "|---------|---------|-----------|"
            for filename in $(ls -1 Country_CIDR | sort); do
              count=${file_stats[$filename]}
              operator=${operator_map[$filename]}
              printf "| %-21s | %-25s | %-9s |\n" "$filename" "$operator" "$count"
            done
            echo ""
            echo "---"
            echo ""
            echo "*æ­¤ä¿¡æ¯ç”± GitHub Actions è‡ªåŠ¨æ›´æ–°äºŽ $TIMESTAMP*"
          } > README.md

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Update IP lists and README"
          branch: main
          file_pattern: 'Country_CIDR/* README.md'
